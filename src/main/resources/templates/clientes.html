<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MS-Clientes</title>
//Cambios de Urbina
<style>
*{margin:0;padding:0;box-sizing:border-box;}

body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    padding:20px;
}

/* HEADER */
.header{
    background:white;
    padding:20px;
    border-radius:8px;
    margin-bottom:25px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

/* LAYOUT */
.container{
    display:flex;
    gap:25px;
    flex-wrap:wrap;
}

.form-section,.table-section{
    background:white;
    padding:25px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

/* üîπ Reducimos un poco el formulario */
.form-section{
    flex:0.9;
    min-width:280px;
}

/* üîπ Damos m√°s espacio a tabla */
.table-section{
    flex:2.1;
    min-width:650px;
}

.table-wrapper{
    overflow-x:auto;
}

/* FORM */
label{
    display:block;
    margin-bottom:5px;
    font-weight:500;
}

input,select{
    width:100%;
    padding:9px;
    margin-bottom:14px;
    border:1px solid #ddd;
    border-radius:4px;
    font-size:13px;
}

button{
    padding:9px 18px;
    background:#667eea;
    color:white;
    border:none;
    border-radius:4px;
    cursor:pointer;
    font-size:13px;
}

button:hover{background:#5568d3;}

.btn-limpiar{
    padding:9px 18px;
    background:#6c757d;
    color:white;
    text-decoration:none;
    border-radius:4px;
    font-size:13px;
}

/* TABLE */
table{
    width:100%;
    border-collapse:collapse;
}

thead{
    background:#667eea;
    color:white;
}

th,td{
    padding:10px;
    border-bottom:1px solid #ddd;
    font-size:13px;
    white-space:nowrap;
}

tbody tr:hover{
    background:#f4f6ff;
}

/* ESTADO */
.estado-form{
    display:flex;
    gap:5px;
    align-items:center;
}

.estado-form select{
    width:auto;
    padding:5px;
}

/* üî• BOTONES ACCIONES CUADROS */
.btn-edit{
    display:inline-block;
    background:#ff9800;
    color:white;
    padding:6px 12px;
    border-radius:6px;
    text-decoration:none;
    font-size:12px;
    font-weight:500;
    margin-right:5px;
}

.btn-edit:hover{
    background:#e68900;
}

.btn-delete{
    display:inline-block;
    background:#f44336;
    color:white;
    padding:6px 12px;
    border-radius:6px;
    text-decoration:none;
    font-size:12px;
    font-weight:500;
}

.btn-delete:hover{
    background:#d32f2f;
}

/* ===== MODAL BONITO ===== */
.modal-overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.5);
    display:flex;
    justify-content:center;
    align-items:center;
    opacity:0;
    visibility:hidden;
    transition:all 0.3s ease;
    z-index:1000;
}

.modal-overlay.active{
    opacity:1;
    visibility:visible;
}

.modal{
    background:white;
    padding:30px;
    border-radius:10px;
    width:350px;
    text-align:center;
    transform:scale(0.8);
    transition:all 0.3s ease;
}

.modal-overlay.active .modal{
    transform:scale(1);
}

.modal h3{
    margin-bottom:15px;
}

.modal p{
    margin-bottom:20px;
    font-size:14px;
}

.modal button{
    width:100%;
    background:#dc3545;
}

.modal.success button{
    background:#28a745;
}
</style>

<script>
// =======================
// VALIDACIONES DE TECLADO
// =======================

// C√©dula / Edad: solo n√∫meros
function soloNumeros(e){
    const key = e.key;

    // permitir navegaci√≥n y edici√≥n
    const permitidos = ["Backspace","Delete","Tab","ArrowLeft","ArrowRight","Home","End"];
    if (permitidos.includes(key)) return;

    // permitir ctrl/cmd combos
    if (e.ctrlKey || e.metaKey) return;

    if(!/^[0-9]$/.test(key)){
        e.preventDefault();
    }
}

// Nombres / Apellidos: solo letras (con tildes) y espacios
function soloLetras(e){
    const key = e.key;

    const permitidos = ["Backspace","Delete","Tab","ArrowLeft","ArrowRight","Home","End"];
    if (permitidos.includes(key)) return;

    if (e.ctrlKey || e.metaKey) return;

    // letras + tildes + √± + espacio
    if(!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë ]$/.test(key)){
        e.preventDefault();
    }
}

// Tel√©fono: n√∫meros y opcional "+" SOLO al inicio
function soloTelefono(e){
    const input = e.target;
    const key = e.key;

    const permitidos = ["Backspace","Delete","Tab","ArrowLeft","ArrowRight","Home","End"];
    if (permitidos.includes(key)) return;

    if (e.ctrlKey || e.metaKey) return;

    // permitir "+" solo si est√° al inicio y no existe ya
    if(key === "+"){
        const cursorAlInicio = (input.selectionStart === 0);
        const noTieneMas = !input.value.includes("+");
        if (cursorAlInicio && noTieneMas) return;
        e.preventDefault();
        return;
    }

    // permitir solo n√∫meros
    if(!/^[0-9]$/.test(key)){
        e.preventDefault();
    }
}

// Bloqueo al pegar (paste) para evitar letras/mezclas
function limpiarPegadoSoloNumeros(e){
    e.preventDefault();
    const texto = (e.clipboardData || window.clipboardData).getData("text");
    const limpio = texto.replace(/[^0-9]/g,"");
    document.execCommand("insertText", false, limpio);
}

function limpiarPegadoSoloLetras(e){
    e.preventDefault();
    const texto = (e.clipboardData || window.clipboardData).getData("text");
    const limpio = texto.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë ]/g,"");
    document.execCommand("insertText", false, limpio);
}

function limpiarPegadoTelefono(e){
    e.preventDefault();
    const texto = (e.clipboardData || window.clipboardData).getData("text");

    // permite solo n√∫meros y un "+" si es el primer car√°cter
    let limpio = texto.replace(/[^0-9+]/g,"");
    // si tiene + en medio lo eliminamos
    limpio = limpio.replace(/\+/g,"");
    // si el texto original empezaba con +, lo agregamos al inicio
    if(texto.trim().startsWith("+")){
        limpio = "+" + limpio;
    }
    document.execCommand("insertText", false, limpio);
}


// =======================
// VALIDACI√ìN ECUADOR C√âDULA
// =======================
function validarCedula(cedula){
    if(cedula.length !== 10) return false;

    let total=0;
    for(let i=0;i<9;i++){
        let num=parseInt(cedula[i]);
        if(i%2===0){
            num*=2;
            if(num>9) num-=9;
        }
        total+=num;
    }

    let verificador=(10-(total%10))%10;
    return verificador===parseInt(cedula[9]);
}

// =======================
// MODAL
// =======================
function mostrarModal(titulo,mensaje,tipo="error"){
    const overlay=document.getElementById("modalOverlay");
    const modal=document.getElementById("modalBox");

    modal.className="modal "+(tipo==="success"?"success":"");
    document.getElementById("modalTitle").innerText=titulo;
    document.getElementById("modalMessage").innerText=mensaje;

    overlay.classList.add("active");
}

function cerrarModal(){
    document.getElementById("modalOverlay").classList.remove("active");
}

// =======================
// VALIDAR FORM
// =======================
function validarFormulario(){
    let cedula=document.getElementById("cedula").value;

    if(!validarCedula(cedula)){
        mostrarModal(
            "C√©dula inv√°lida",
            "La c√©dula ingresada no es v√°lida. Verifique el n√∫mero.",
            "error"
        );
        return false;
    }

    return true;
}
</script>

</head>

<body>

<div class="header">
    <h2>Gesti√≥n de Clientes</h2>
</div>

<div class="container">

<!-- FORMULARIO -->
<div class="form-section">
<h3 th:text="${cliente.id == null ? 'Nuevo Cliente' : 'Editar Cliente'}"></h3>

<form th:action="@{/clientes/web/guardar}"
      th:object="${cliente}"
      method="post"
      onsubmit="return validarFormulario()">

<input type="hidden" th:field="*{id}"/>

<label>C√©dula</label>
<input type="text"
       id="cedula"
       th:field="*{cedula}"
       maxlength="10"
       required
       onkeydown="soloNumeros(event)"
       onpaste="limpiarPegadoSoloNumeros(event)">

<label>Nombres</label>
<input type="text"
       th:field="*{nombre}"
       required
       onkeydown="soloLetras(event)"
       onpaste="limpiarPegadoSoloLetras(event)">

<label>Apellidos</label>
<input type="text"
       th:field="*{apellido}"
       required
       onkeydown="soloLetras(event)"
       onpaste="limpiarPegadoSoloLetras(event)">

<label>Edad</label>
<input type="number"
       th:field="*{edad}"
       min="18"
       required
       onkeydown="soloNumeros(event)"
       onpaste="limpiarPegadoSoloNumeros(event)">

<label>Correo</label>
<input type="email" th:field="*{correo}" required>

<label>Tel√©fono</label>
<input type="text"
       th:field="*{telefono}"
       required
       onkeydown="soloTelefono(event)"
       onpaste="limpiarPegadoTelefono(event)">

<label>Direcci√≥n</label>
<input type="text" th:field="*{direccion}" required>

<button type="submit">Guardar</button>
<a href="/clientes/web" class="btn-limpiar">Cancelar</a>

</form>
</div>

<!-- TABLA -->
<div class="table-section">
<h3>Lista de Clientes</h3>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>ID</th>
<!--<th>C√©dula</th>-->
<!--<th>Nombres</th>-->
<th>Apellidos</th>
<th>Edad</th>
<th>Correo</th>
<th>Tel√©fono</th>
<th>Direcci√≥n</th>
<th>Fecha</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>

<tbody>
<tr th:each="c : ${clientes}">
<td th:text="${c.id}"></td>
<td th:text="${c.cedula}"></td>
<td th:text="${c.nombre}"></td>
<td th:text="${c.apellido}"></td>
<td th:text="${c.edad}"></td>
<td th:text="${c.correo}"></td>
<td th:text="${c.telefono}"></td>
<td th:text="${c.direccion}"></td>
<td th:text="${#temporals.format(c.fechaRegistro,'dd/MM/yyyy HH:mm')}"></td>

<td>
<form th:action="@{/clientes/web/estado/{id}(id=${c.id})}"
      method="post"
      class="estado-form">
<select name="estado">
<option value="ACTIVO"
 th:selected="${c.estado == 'ACTIVO'}">ACTIVO</option>
<option value="INACTIVO"
 th:selected="${c.estado == 'INACTIVO'}">INACTIVO</option>
</select>
<button type="submit">‚úî</button>
</form>
</td>

<td>
<a class="btn-edit"
   th:href="@{/clientes/web/editar/{id}(id=${c.id})}">
   Editar
</a>

<a class="btn-delete"
   th:href="@{/clientes/web/eliminar/{id}(id=${c.id})}"
   onclick="return confirm('¬øEliminar cliente?')">
   Eliminar
</a>
</td>

</tr>
</tbody>
</table>
</div>

</div>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="modal-overlay">
<div id="modalBox" class="modal">
<h3 id="modalTitle"></h3>
<p id="modalMessage"></p>
<button onclick="cerrarModal()">Aceptar</button>
</div>
</div>

<script th:if="${errorMensaje != null}">
    mostrarModal("Error", "[[${errorMensaje}]]", "error");
</script>

</body>
</html>
